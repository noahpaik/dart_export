name: CI

on:
  push:
    branches:
      - "**"
  pull_request:
  schedule:
    # Daily at 03:00 UTC
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      run_online_checks:
        description: "Run DART online checks (requires DART_API_KEY secret)"
        required: false
        type: boolean
        default: false
      run_online_strict_trackc:
        description: "Run online strict Track C gate (tries real companies)"
        required: false
        type: boolean
        default: false
      run_online_step8_regression:
        description: "Run online Step8 integration regression gate"
        required: false
        type: boolean
        default: false
      run_online_step8_multi_report_regression:
        description: "Run online Step8 multi-report regression gate (11012/11013/11014)"
        required: false
        type: boolean
        default: false
      run_online_step8_multi_report_year_matrix_regression:
        description: "Run online Step8 multi-report year-matrix regression gate (11012/11013/11014, 2022-2024)"
        required: false
        type: boolean
        default: false
      run_online_step8_year_matrix_regression:
        description: "Run online Step8 year-matrix regression gate (2022,2023,2024)"
        required: false
        type: boolean
        default: false

jobs:
  offline-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Syntax Check
        run: |
          python -m py_compile main.py src/*.py

      - name: Config Check
        run: |
          python main.py --check-config

      - name: Unit Tests
        run: |
          python -m unittest discover -s tests -v

      - name: Track C Strict Fixture Gate
        run: |
          python main.py --step3-parse-xbrl --xbrl-dir tests/fixtures/trackc_strict_sample

      - name: Required CLI Flags
        run: |
          set -euo pipefail
          python main.py -h > /tmp/main_help.txt
          grep -q -- "--check-network" /tmp/main_help.txt
          grep -q -- "--step8-strict-trackc" /tmp/main_help.txt
          grep -q -- "--step8-skip-trackc" /tmp/main_help.txt
          grep -q -- "--step8-enable-llm-normalize" /tmp/main_help.txt
          grep -q -- "--step8-normalizer-cache-policy" /tmp/main_help.txt

  online-checks:
    runs-on: ubuntu-latest
    needs: offline-checks
    if: >-
      ${{
        secrets.DART_API_KEY != '' &&
        (
          github.event_name == 'schedule' ||
          (
            github.event_name == 'workflow_dispatch' &&
            inputs.run_online_checks == true
          )
        )
      }}
    env:
      DART_API_KEY: ${{ secrets.DART_API_KEY }}
      STEP8_ARTIFACT_ROOT: /tmp/step8_online_artifacts
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Network Check
        run: |
          python main.py --check-network --verbose

      - name: DART Latest Report Probe
        run: |
          python main.py --step1-latest-report --company-name 삼성전자 --year 2024 --report-code 11011

      - name: Track C Strict Online Gate
        if: >-
          ${{
            github.event_name == 'schedule' ||
            (
              github.event_name == 'workflow_dispatch' &&
              inputs.run_online_strict_trackc == true
            )
          }}
        run: |
          python tests/online_trackc_strict_gate.py --candidates 삼성전자,SK하이닉스 --years 2024 --min-success 2 --max-attempts 2

      - name: Step8 Integration Online Regression
        if: >-
          ${{
            github.event_name == 'schedule' ||
            (
              github.event_name == 'workflow_dispatch' &&
              inputs.run_online_step8_regression == true
            )
          }}
        run: |
          python tests/online_step8_integration_gate.py \
            --matrix-config config/online_step8_matrix.yaml \
            --matrix base \
            --output-dir "${STEP8_ARTIFACT_ROOT}/base"

      - name: Step8 Multi-Report Regression
        if: >-
          ${{
            github.event_name == 'schedule' ||
            (
              github.event_name == 'workflow_dispatch' &&
              inputs.run_online_step8_multi_report_regression == true
            )
          }}
        run: |
          python tests/online_step8_integration_gate.py \
            --matrix-config config/online_step8_matrix.yaml \
            --matrix multi_report \
            --output-dir "${STEP8_ARTIFACT_ROOT}/multi_report"

      - name: Step8 Multi-Report Year-Matrix Regression
        if: >-
          ${{
            github.event_name == 'schedule' ||
            (
              github.event_name == 'workflow_dispatch' &&
              inputs.run_online_step8_multi_report_year_matrix_regression == true
            )
          }}
        run: |
          python tests/online_step8_integration_gate.py \
            --matrix-config config/online_step8_matrix.yaml \
            --matrix multi_report_year_matrix \
            --output-dir "${STEP8_ARTIFACT_ROOT}/multi_report_year_matrix"

      - name: Step8 Year-Matrix Regression
        if: >-
          ${{
            github.event_name == 'schedule' ||
            (
              github.event_name == 'workflow_dispatch' &&
              inputs.run_online_step8_year_matrix_regression == true
            )
          }}
        run: |
          python tests/online_step8_integration_gate.py \
            --matrix-config config/online_step8_matrix.yaml \
            --matrix year_matrix \
            --output-dir "${STEP8_ARTIFACT_ROOT}/year_matrix"

      - name: Collect Step8 Warning Metrics
        if: >-
          ${{
            always() &&
            (
              github.event_name == 'schedule' ||
              (
                github.event_name == 'workflow_dispatch' &&
                (
                  inputs.run_online_step8_regression == true ||
                  inputs.run_online_step8_multi_report_regression == true ||
                  inputs.run_online_step8_multi_report_year_matrix_regression == true ||
                  inputs.run_online_step8_year_matrix_regression == true
                )
              )
            )
          }}
        run: |
          python tests/collect_step8_warning_metrics.py \
            --summary-root "${STEP8_ARTIFACT_ROOT}" \
            --output-json "${STEP8_ARTIFACT_ROOT}/metrics/step8_warning_metrics.json" \
            --output-md "${STEP8_ARTIFACT_ROOT}/metrics/step8_warning_metrics.md"

      - name: Build Step8 Warning Trend Report
        if: >-
          ${{
            always() &&
            (
              github.event_name == 'schedule' ||
              (
                github.event_name == 'workflow_dispatch' &&
                (
                  inputs.run_online_step8_regression == true ||
                  inputs.run_online_step8_multi_report_regression == true ||
                  inputs.run_online_step8_multi_report_year_matrix_regression == true ||
                  inputs.run_online_step8_year_matrix_regression == true
                )
              )
            )
          }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python tests/collect_step8_warning_trends.py \
            --current-metrics-json "${STEP8_ARTIFACT_ROOT}/metrics/step8_warning_metrics.json" \
            --history-dir "${STEP8_ARTIFACT_ROOT}/history" \
            --output-json "${STEP8_ARTIFACT_ROOT}/metrics/step8_warning_trends.json" \
            --output-md "${STEP8_ARTIFACT_ROOT}/metrics/step8_warning_trends.md" \
            --recent-runs 5 \
            --fetch-from-github \
            --github-repo "${GITHUB_REPOSITORY}" \
            --github-token "${GITHUB_TOKEN}" \
            --quality-gate-config "config/step8_warning_quality_gate.yaml" \
            --fail-on-quality-gate

      - name: Upload Step8 Metrics Artifact
        if: >-
          ${{
            always() &&
            (
              github.event_name == 'schedule' ||
              (
                github.event_name == 'workflow_dispatch' &&
                (
                  inputs.run_online_step8_regression == true ||
                  inputs.run_online_step8_multi_report_regression == true ||
                  inputs.run_online_step8_multi_report_year_matrix_regression == true ||
                  inputs.run_online_step8_year_matrix_regression == true
                )
              )
            )
          }}
        uses: actions/upload-artifact@v4
        with:
          name: step8-warning-metrics
          path: /tmp/step8_online_artifacts
          if-no-files-found: warn
