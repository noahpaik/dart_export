name: CI

on:
  push:
    branches:
      - "**"
  pull_request:
  workflow_dispatch:
    inputs:
      run_online_checks:
        description: "Run DART online checks (requires DART_API_KEY secret)"
        required: false
        type: boolean
        default: false
      run_online_strict_trackc:
        description: "Run online strict Track C gate (tries real companies)"
        required: false
        type: boolean
        default: false

jobs:
  offline-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Syntax Check
        run: |
          python -m py_compile main.py src/*.py

      - name: Config Check
        run: |
          python main.py --check-config

      - name: Unit Tests
        run: |
          python -m unittest discover -s tests -v

      - name: Track C Strict Fixture Gate
        run: |
          python main.py --step3-parse-xbrl --xbrl-dir tests/fixtures/trackc_strict_sample

      - name: Required CLI Flags
        run: |
          set -euo pipefail
          python main.py -h > /tmp/main_help.txt
          grep -q -- "--check-network" /tmp/main_help.txt
          grep -q -- "--step8-strict-trackc" /tmp/main_help.txt
          grep -q -- "--step8-skip-trackc" /tmp/main_help.txt

  online-checks:
    runs-on: ubuntu-latest
    needs: offline-checks
    if: >-
      ${{
        github.event_name == 'workflow_dispatch' &&
        inputs.run_online_checks == true &&
        secrets.DART_API_KEY != ''
      }}
    env:
      DART_API_KEY: ${{ secrets.DART_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Network Check
        run: |
          python main.py --check-network --verbose

      - name: DART Latest Report Probe
        run: |
          python main.py --step1-latest-report --company-name 삼성전자 --year 2024 --report-code 11011

      - name: Track C Strict Online Gate
        if: ${{ inputs.run_online_strict_trackc == true }}
        run: |
          python tests/online_trackc_strict_gate.py --years 2024 --min-success 1 --max-attempts 4
